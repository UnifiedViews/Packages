#!/bin/sh
# postinst script for #PACKAGE#
#
# see: dh_installdeb(1)

set -e

# summary of how this script can be called:
#        * <postinst> `configure' <most-recently-configured-version>
#        * <old-postinst> `abort-upgrade' <new version>
#        * <conflictor's-postinst> `abort-remove' `in-favour' <package>
#          <new-version>
#        * <postinst> `abort-remove'
#        * <deconfigured's-postinst> `abort-deconfigure' `in-favour'
#          <failed-install-package> <version> `removing'
#          <conflicting-package> <version>
# for details, see http://www.debian.org/doc/debian-policy/ or
# the debian-policy package


set_java() {
 JAVA_VERSION=`java -version 2>&1 | grep "java version" | awk '{print $3}' | tr -d \" | awk '{split($0, array, ".")} END{print array[2]}'`
 echo -n "check java version"
 if [ ! $JAVA_VERSION -eq 7 ]; then
     JAVA_NAME=`update-java-alternatives  -l | grep 7 | cut -d' ' -f1`
     if [ -n $JAVA_NAME ] ; then
         /usr/sbin/update-java-alternatives --jre-headless --set $JAVA_NAME
     echo " - Java version is set to 1.7"
     else
        echo " ERROR: java 7 is not installed"
     fi
 else
    echo  " - ok"
 fi
}




create_credentials() {
  echo ">>> create_credentials"
  if ! id unifiedviews > /dev/null 2>&1 ; then
    adduser  --group  --system --no-create-home --disabled-password --home /usr/share/unifiedviews unifiedviews
  fi
  echo "<<< create_credentials"
}


prepare_dir() { 
    mkdir -p /var/log/unifiedviews/backend
    chown unifiedviews:unifiedviews /var/log/unifiedviews/backend
    
    mkdir -p /var/log/unifiedviews/backend
    chown unifiedviews:unifiedviews /var/log/unifiedviews /var/log/unifiedviews/backend

    mkdir -p /var/lib/unifiedviews/backend/working
    chown unifiedviews:unifiedviews  /var/lib/unifiedviews/backend  /var/lib/unifiedviews/backend/working

    mkdir -p /var/lib/unifiedviews/target
    chown unifiedviews:unifiedviews /var/lib/unifiedviews/target /var/lib/unifiedviews/target

    mkdir -p /var/lib/unifiedviews/target/
    chown unifiedviews:unifiedviews /var/lib/unifiedviews/backend/working
    
    mkdir -p ~unifiedviews/.eclipse
    chown -R unifiedviews:unifiedviews ~unifiedviews/.eclipse

    chown unifiedviews:unifiedviews /usr/share/unifiedviews
    
    mkdir -p /var/lib/unifiedviews/target/lib
    chown unifiedviews:unifiedviews /var/lib/unifiedviews/target/lib
    
    mkdir -p /var/lib/unifiedviews/target/dpu
    chown unifiedviews:unifiedviews /var/lib/unifiedviews/target/dpu
    
}


case "$1" in
  configure)
    set_java
    create_credentials
    prepare_dir
  ;;

  abort-upgrade|abort-remove|abort-deconfigure)
  ;;

  *)
    echo "postinst called with unknown argument \`$1'" >&2
    exit 1
    
  ;;
esac


# dh_installdeb will replace this with shell code automatically
# generated by other debhelper scripts.

#DEBHELPER#

exit 0
